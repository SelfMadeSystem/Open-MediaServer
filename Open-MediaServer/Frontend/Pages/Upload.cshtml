@page
@using Open_MediaServer
@using Open_MediaServer.Utils
@model Open_MediaServer.Frontend.Pages.Upload

@{
    Layout = "_Layout.cshtml";

    if (Request.Cookies["user_session"] == null || !UserUtils.IsAuthed(Request.Cookies["user_session"]))
    {
        Response.Redirect("/Login?returnUrl=Upload");
        return;
    }
}

@section AdditionalHead
{
    <title>@Program.ConfigManager.Config.FrontendName Media - Upload</title>
    <link rel="stylesheet" href="~/Frontend/Assets/css/Upload/Upload.css">
}

<!DOCTYPE html>

<html lang="en">

<script>
var id = 0;
function dragOverHandler(ev) {
  ev.preventDefault();
}
function dropHandler(ev) {
    ev.preventDefault();
    if (ev.dataTransfer.files) {
        for (let i = 0; i < ev.dataTransfer.files.length; i++) {
            let file = ev.dataTransfer.files[i];
            id++;
            addContainer(ev);
            document.getElementById("Name " + id).value = file.name;
            document.getElementById("File " + id).files = ev.dataTransfer.files;
            itemChange(ev.dataTransfer, i, id);
        }
    }
}

function addContainer(ev) {
    if (id >= 9) {
        return;
    }
    document.getElementById("file-drag-container").insertAdjacentHTML("beforebegin", '<div class="file-upload">\n<div>\n<video class="file-upload-preview" id="Video Preview ' + id + '" muted></video>\n<img class="file-upload-preview" id="Img Preview ' + id + '"/>\n<div class="file-no-preview" id="No Preview ' + id + '">No file preview</div>\n</div>\n<div class="file-input-area">\n<div>\n<input class="file-upload-input" type="file" id="File ' + id + '" name="File '+ id +'" onchange="itemChange(this, 0, '+ id +');">\n<label class="file-upload-input-label" for="File ' + id +'">\n<span>Change file</span>\n</label>\n</div>\n<div>\n<div class="file-name-input-label">\n<span>Name</span>\n</div>\n<input class="file-name-input" type="text" id="Name '+ id + '" name="Name '+ id +'">\n</div>\n<div>\n<div class="file-private-input-label">\n<span>Private</span>\n</div>\n<input class="file-private-input" type="checkbox" id="Private ' + id + '" name="Private '+ id +'">\n</div>\n</div>\n</div>');
}

function itemChange(input, fileId, id) {
    if (input.files) {
        let file = input.files[fileId];
        document.getElementById("Name " + id).value = file.name;
        let fileReader = new FileReader();
        fileReader.readAsDataURL(file);
        fileReader.onload = function(event) {
            let videoPreview =  document.getElementById("Video Preview " + id);
            let imgPreview =  document.getElementById("Img Preview " + id);
            let noPreview =  document.getElementById("No Preview " + id);
            noPreview.style.display = "none";
            if (file.type === "video/mp4" || file.type === "video/x-msvideo" || file.type === "video/quicktime" || file.type === "video/webm" || file.type === "video/x-ms-wmv") {
                videoPreview.src = event.target.result;
                videoPreview.style.display = "inline-block";
                imgPreview.style.display = "none";
                return;
            }
            imgPreview.src = event.target.result;
            imgPreview.style.display = "inline-block";
            videoPreview.style.display = "none";
        };
    }
}
</script>

<body ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
@using (Html.BeginForm("PostUploadContentForm", "MediaApi", FormMethod.Post, new {@autocomplete = "off", @class = "file-upload-container", @enctype = "multipart/form-data"}))
{
    <div class="file-upload">
        <div>
            <video class="file-upload-preview" id="Video Preview 0" muted></video>
            <img class="file-upload-preview" id="Img Preview 0"/>
            <div class="file-no-preview" id="No Preview 0">No file preview</div>
        </div>
        <div class="file-input-area">
            <div>
                <input class="file-upload-input" type="file" id="File 0" name="File 0" onchange="itemChange(this, 0, 0);">
                <label class="file-upload-input-label" for="File 0">
                    <span>Change file</span>
                </label>
            </div>
            <div>
                <div class="file-name-input-label">
                    <span>Name</span>
                </div>
                <input class="file-name-input" type="text" id="Name 0" name="Name 0">
            </div>
            <div>
                <div class="file-private-input-label">
                    <span>Private</span>
                </div>
                <input class="file-private-input" type="checkbox" id="Private 0" name="Private 0">
            </div>
        </div>
    </div>
    <div id="file-drag-container"></div>
    @Html.TextBox("returnURL", "/Content", new {@type = "hidden"})
    <input class="file-upload-button" id="form-upload-button" type="submit" value="Upload"/>
}
</body>
</html>